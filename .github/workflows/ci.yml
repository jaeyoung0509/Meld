name: Openportio CI

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop]

jobs:
  core-build-test:
    name: Core Build And Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Workspace format check
        run: cargo fmt --all -- --check

      - name: Workspace clippy check
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Workspace check
        run: cargo check --workspace

      - name: Workspace tests
        run: cargo test --workspace

      - name: Production example tests
        run: cargo test -p production-api -- --nocapture

  nextest:
    name: Nextest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Run nextest workspace suite
        run: cargo nextest run --workspace --all-targets

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Add LLVM tools preview
        run: rustup component add llvm-tools-preview

      - name: Generate coverage artifacts
        run: |
          mkdir -p target/coverage
          cargo llvm-cov --workspace --summary-only | tee target/coverage/summary.txt
          cargo llvm-cov --workspace --lcov --output-path target/coverage/lcov.info

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            target/coverage/summary.txt
            target/coverage/lcov.info

  rest-grpc-e2e:
    name: REST gRPC E2E
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run multiplexing integration test
        run: cargo test -p openportio-server --test multiplexing -- --nocapture

  docs-contract:
    name: Docs Contract Drift Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Check generated contract artifacts are up-to-date
        run: ./scripts/check_contracts_bundle.sh

      - name: Verify OpenAPI route test
        run: cargo test -p openportio-server openapi_json_is_available -- --nocapture

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        run: cargo audit

  prod-preflight:
    name: Production Preflight
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run production preflight gate
        env:
          OPENPORTIO_PREFLIGHT_SECURE: "true"
          OPENPORTIO_PREFLIGHT_BOOT_SERVER: "true"
          OPENPORTIO_PREFLIGHT_WAIT_SECONDS: "120"
          OPENPORTIO_PREFLIGHT_BASE_URL: "http://127.0.0.1:3000"
          OPENPORTIO_AUTH_ENABLED: "true"
          OPENPORTIO_AUTH_JWT_SECRET: "ci-dev-secret"
          OPENPORTIO_AUTH_ISSUER: "https://issuer.local"
          OPENPORTIO_AUTH_AUDIENCE: "openportio-api"
          OPENPORTIO_CORS_ALLOW_ORIGINS: "https://app.example.com"
          OPENPORTIO_TIMEOUT_SECONDS: "15"
          OPENPORTIO_REQUEST_BODY_LIMIT_BYTES: "1048576"
          OPENPORTIO_MAX_IN_FLIGHT_REQUESTS: "1024"
        run: ./scripts/prod_preflight.sh

  release-dry-run:
    name: Release Dry Run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Validate publish dry-run for release crates
        run: ./scripts/release_dry_run.sh
